// Generated by CoffeeScript 1.6.2
(function() {
  var homeViewTpl, loadCredentials, loadData, loadDataFromHomeView, login, setup, webservicesUrl;

  document.addEventListener('deviceready', function() {
    return console.log('Phonegap framework initialized');
  });

  webservicesUrl = 'http://192.168.0.193:8080';

  Ext.application({
    launch: function() {
      setup();
      Ext.widget('mainView', {
        fullscreen: true
      });
      return console.log('Initialized the app successfully');
    }
  });

  setup = function() {
    Ext.Viewport.setMasked({
      xtype: 'loadmask',
      message: 'Cargando datos....',
      indicator: true
    });
    return Ext.Viewport.setMasked(false);
  };

  login = function() {
    var values;

    values = Ext.getCmp('loginView_form').getValues();
    if (!values.username || !values.password || !values.secretDate) {
      return Ext.Msg.alert('Aviso del sistema', 'No has rellenado todos los campos.');
    } else {
      return loadData(values.username, values.password, Ext.Date.format(values.secretDate, 'dmY'));
    }
  };

  loadData = function(username, password, secretDate) {
    Ext.Viewport.setMasked(true);
    return Ext.getStore('userDataStore').load({
      callback: function(records, operation, success) {
        Ext.Viewport.setMasked(false);
        if (!success) {
          return Ext.Msg.alert('Aviso del sistema', 'Ha fallado la autenticación.');
        } else {
          Ext.getCmp('mainView').setActiveItem(1);
          localStorage.username = username;
          localStorage.password = password;
          return localStorage.secretDate = secretDate;
        }
      },
      params: {
        'username': username,
        'password': password,
        'date': secretDate
      }
    });
  };

  loadCredentials = function() {
    if (localStorage.username) {
      return Ext.getCmp('loginView_form').setValues({
        'username': localStorage.username,
        'password': localStorage.password,
        'secretDate': Ext.Date.parse(localStorage.secretDate, 'dmY')
      });
    }
  };

  loadDataFromHomeView = function() {
    if (localStorage.username) {
      return loadData(localStorage.username, localStorage.password, localStorage.secretDate);
    } else {
      return Ext.getCmp('mainView').setActiveItem(0);
    }
  };

  homeViewTpl = new Ext.XTemplate("<div id=\"homeView_amount\">\n  <span>--{username}</span>--\n  <div id=\"homeView_amount_1\">\n    SALDO<br/>DISPONIBLE\n  </div>\n  <div id=\"homeView_amount_2\">\n    {amount}\n  </div> \n</div>\n\n<div id=\"homeView_movements\">\n <tpl for=\"movements\">\n    <div id=\"homeView_movements_item\">\n      <div id=\"homeView_movements_item_concept\">\n        {concept}\n      </div>\n      <div id=\"homeView_movements_item_remainder\">\n        <span id=\"homeView_movements_item_remainder_date\">{date}</span>\n        </br>\n        <span id=\"homeView_movements_item_remainder_amount\">{amount}</span>\n      </div>\n    </div>\n    \n </tpl>\n</div>");

  Ext.define('ticketsRestaurant.HomeView', {
    extend: 'Ext.Panel',
    xtype: 'homeView',
    config: {
      id: 'homeView',
      layout: {
        type: 'vbox'
      },
      items: [
        {
          xtype: 'titlebar',
          title: 'Tarj. Ticket Restaurant®',
          height: '50px',
          layout: {
            type: 'hbox'
          },
          items: [
            {
              xtype: 'button',
              iconCls: 'refresh',
              iconMask: true,
              handler: function() {
                return loadDataFromHomeView();
              }
            }
          ]
        }, {
          xtype: 'dataview',
          itemTpl: homeViewTpl,
          store: {
            xtype: 'userdatastore'
          },
          loadingText: '',
          flex: 1
        }
      ]
    }
  });

  Ext.define('ticketsRestaurant.LoginView', {
    extend: 'Ext.Panel',
    xtype: 'loginView',
    config: {
      id: 'loginView',
      layout: {
        type: 'vbox'
      },
      items: [
        {
          id: 'loginView_header',
          xtype: 'label',
          html: 'Accede a tu area privada'
        }, {
          id: 'loginView_remainder',
          xtype: 'label',
          html: 'Introduce tus credenciales'
        }, {
          id: 'loginView_form',
          xtype: 'formpanel',
          height: '200px',
          defaults: {
            cls: 'field',
            labelCls: 'fieldLabel'
          },
          items: [
            {
              id: 'loginView_username',
              xtype: 'textfield',
              name: 'username',
              label: 'Usuario:',
              placeHolder: 'Tu usuario',
              labelWidth: '125x',
              required: true
            }, {
              id: 'loginView_password',
              xtype: 'passwordfield',
              name: 'password',
              label: 'Contraseña:',
              placeHolder: 'Tu contraseña',
              labelWidth: '125px',
              required: true
            }, {
              id: 'loginView_secretDate',
              xtype: 'datepickerfield',
              name: 'secretDate',
              label: 'Fecha:',
              placeHolder: 'Fecha secreta',
              labelWidth: '125px',
              dateFormat: 'd/m/Y',
              picker: {
                yearFrom: new Date().getFullYear() - 50,
                yearTo: new Date().getFullYear(),
                cancelButton: 'Cancelar',
                doneButton: 'Establecer'
              },
              required: true
            }
          ]
        }, {
          id: 'loginView_login',
          xtype: 'button',
          text: 'Continuar',
          ui: 'plain',
          handler: function() {
            return login();
          }
        }, {
          id: 'loginView_footer',
          xtype: 'label',
          docked: 'bottom',
          height: '50px'
        }
      ],
      listeners: {
        painted: function() {
          return loadCredentials();
        }
      }
    }
  });

  Ext.define('ticketsRestaurant.MainView', {
    extend: 'Ext.Container',
    xtype: 'mainView',
    config: {
      id: 'mainView',
      layout: {
        type: 'card'
      },
      items: [
        {
          xtype: 'loginView'
        }, {
          xtype: 'homeView'
        }
      ]
    }
  });

  Ext.define('ticketsRestaurant.MovementModel', {
    extend: 'Ext.data.Model',
    config: {
      fields: ['date', 'concept', 'amount']
    }
  });

  Ext.define('ticketsRestaurant.UserDataModel', {
    extend: 'Ext.data.Model',
    config: {
      fields: [
        {
          name: 'username',
          type: 'string'
        }, {
          name: 'amount',
          type: 'string'
        }
      ],
      hasMany: [
        {
          model: 'ticketsRestaurant.MovementModel',
          name: 'movements',
          associationKey: 'movements'
        }
      ]
    }
  });

  Ext.define('ticketsRestaurant.UserDataStore', {
    extend: 'Ext.data.Store',
    xtype: 'userdatastore',
    config: {
      model: 'ticketsRestaurant.UserDataModel',
      autoLoad: false,
      storeId: 'userDataStore',
      /*
      data:[
        {
          username:'jose miguel'
          amount:'128 �'
        }
      ]
      */

      proxy: {
        type: 'ajax',
        timeout: 90000,
        url: webservicesUrl + "/robotController/getData"
      }
    }
  });

}).call(this);
